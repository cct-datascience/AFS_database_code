---
title: "Approach to process user upload data"
author: "Kristina Riemer"
date: '2023-01-20'
output: html_document
---

## Purpose

Users will upload raw data, which will have length and/or weight measurements with one row per observation (a single fish or multiple fish summed). These data need to be summarized to the three metrics of interest for each unique combination of area, species, collection method, type of water body, and year. The three metrics are: 

1. [Catch per unit effort](https://en.wikipedia.org/wiki/Catch_per_unit_effort) (CPUE)
2. Length frequency
3. Relative weight

## Defining user inputs

- Date will need to be three separate columns with month, day, and year
- Length in what units? 
- Weight in what units? 
- Species will be common species, needs to be in this list from `FSA::PSDlit` and match exactly: 

 [1] "Arctic Grayling"            
 [2] "Bighead Carp"               
 [3] "Bigmouth Buffalo"           
 [4] "Black Bullhead"             
 [5] "Black Carp"                 
 [6] "Black Crappie"              
 [7] "Blue Catfish"               
 [8] "Bluegill"                   
 [9] "Brook Trout (lentic)"       
[10] "Brook Trout (lotic)"        
[11] "Brook Trout"                
[12] "Brown Bullhead"             
[13] "Brown Trout (lentic)"       
[14] "Brown Trout (lotic)"        
[15] "Bull Trout"                 
[16] "Burbot"                     
[17] "Chain Pickerel"             
[18] "Channel Catfish"            
[19] "Chinook Salmon (landlocked)"
[20] "Common Carp"                
[21] "Cutthroat Trout"            
[22] "Flathead Catfish"           
[23] "Freshwater Drum"            
[24] "Gizzard Shad"               
[25] "Golden Trout"               
[26] "Grass Carp"                 
[27] "Green Sunfish"              
[28] "Kokanee"                    
[29] "Lake Trout"                 
[30] "Largemouth Bass"            
[31] "Longnose Gar"               
[32] "Muskellunge"                
[33] "Northern Pike"              
[34] "Paddlefish"                 
[35] "Pallid Sturgeon"            
[36] "Palmetto Bass"              
[37] "Palmetto Bass (original)"   
[38] "Pumpkinseed"                
[39] "Rainbow Trout"              
[40] "Redear Sunfish"             
[41] "River Carpsucker"           
[42] "Rock Bass"                  
[43] "Ruffe"                      
[44] "Sauger"                     
[45] "Saugeye"                    
[46] "Shoal Bass"                 
[47] "Shorthead Redhorse"         
[48] "Silver Carp"                
[49] "Smallmouth Bass"            
[50] "Smallmouth Buffalo "        
[51] "Splake"                     
[52] "Spotted Bass"               
[53] "Spotted Gar"                
[54] "Striped Bass (landlocked)"  
[55] "Striped Bass (hybrid)"      
[56] "Striped Bass X White Bass"  
[57] "Suwannee Bass"              
[58] "Utah Chub"                  
[59] "Walleye"                    
[60] "Warmouth"                   
[61] "White Bass"                 
[62] "White Catfish"              
[63] "White Crappie"              
[64] "White Perch"                
[65] "White Sucker"               
[66] "Yellow Perch"               
[67] "Yellow Bass"                
[68] "Yellow Bullhead"            


## Prepare to calculate metrics

### Read in libraries
```{r}
library(readxl)
library(dplyr)
library(FSA)
library(ggplot2)
```

### Read in and modify example datasets
```{r}
raw_y1 <- readxl::read_xlsx("../input_examples/AFS_test_data.xlsx") %>%
  tidyr::separate(date, into = c("month", "day", "year"), sep = c(1, 3, 7)) %>% 
  mutate(year = as.numeric(year))
process_example <- read.csv("../input_examples/AFS_processed_test_data.csv")
```

Simulate extra data for additional years for raw data. 
```{r}
raw_y2 <- raw_y1 %>% 
  mutate(year = year + 1, 
         total_length = total_length + 50)

raw_example <- bind_rows(raw_y1, raw_y2)
```


## Calculate metrics

### 1. CPUE


### 2. Length frequency

Calculate Gabelhouse category for each fish record using length and species identity. For each species and each year, determine proportion of records in each category. Then calculate mean and standard for each species across years. 

```{r}
lf <- raw_example %>% 
  select(state, common_name, method, waterbody_type, year, total_length) %>%
  mutate(common_name = stringr::str_to_title(common_name), 
         gcat = psdAdd(total_length, common_name, what = "incremental")) %>% 
  group_by(state, common_name, method, waterbody_type, year) %>% 
  count(gcat) %>% 
  mutate(freq = n / sum(n)) %>% 
  group_by(state, common_name, method, waterbody_type, gcat) %>% 
  summarize_at(vars(freq), list(mean = mean, se = se), na.rm = TRUE)
```

Plot example processed data. 

```{r}
ggplot(lf, aes(x = gcat, y = mean)) +
  geom_bar(stat = "identity") +
  facet_wrap(vars(common_name)) +
        geom_errorbar(aes(ymin = mean - se,
                          ymax = mean + se),
                      width = 0)
```

### 3. Relative weight

```{r, eval=FALSE}
rw <- raw_example %>% 
  select(state, common_name, method, waterbody_type, year, weight) %>%
  group_by(state, common_name, method, waterbody_type, year) %>% 
  wrAdd()
```

