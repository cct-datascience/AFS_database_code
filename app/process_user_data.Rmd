---
title: "Approach to process user upload data"
author: "Kristina Riemer"
date: '2023-01-20'
output: html_document
---

## Purpose

Users will upload raw data, which will have length and/or weight measurements with one row per observation (a single fish or multiple fish summed). These data need to be summarized to the three metrics of interest for each unique combination of area, species, collection method, type of water body, and year. The three metrics are: 

1. [Catch per unit effort](https://en.wikipedia.org/wiki/Catch_per_unit_effort) (CPUE)
2. Length frequency
3. Relative weight

## Defining user inputs

- Date will need to be three separate columns with month, day, and year
- Length (mm)
- Weight (g)
- Effort (s)
- Method needs to be from this list and match name exactly, with corresponding effort column with correct unit and type: 

| **Method name**          | **Effort type** | **Unit** |
|--------------------------|-----------------|----------|
| boat_electrofishing      | Time            | seconds  |
| tow_barge_electrofishing | Time            | seconds  |
| raft_electrofishing      | Time            | seconds  |
| trawl                    | Time            | seconds  |
| gill_net_fall            | Number of nets  | number   |
| gill_net_fall            | Number of nets  | number   |
| hoop_net                 | Number of nets  | number   |
| small_catfish_hoopnet    | Number of nets  | number   |
| large_catfish_hoopnet    | Number of nets  | number   |
| seine                    | Number of nets  | number   |
| bag_seine                | Number of nets  | number   |
| stream_seine             | Number of nets  | number   |
| backpack_electrofishing  | Area            | m2       |
| snorkel                  | Area            | m2       |

- Species will be common species, needs to be in this list from `FSA::PSDlit` and match exactly: 


```{r, echo=FALSE}
species_list <- FSA::PSDlit
print(species_list$species)
```


## Prepare to calculate metrics

### Read in libraries
```{r}
library(readxl)
library(dplyr)
library(FSA)
library(ggplot2)
```

### Read in and modify example datasets
```{r}
raw_y1 <- readxl::read_xlsx("../input_examples/AFS_test_data.xlsx") %>%
  tidyr::separate(date, into = c("month", "day", "year"), sep = c(1, 3, 7)) %>% 
  mutate(year = as.numeric(year), 
         common_name = stringr::str_to_title(common_name))
process_example <- read.csv("../input_examples/AFS_processed_test_data.csv")
```

Simulate extra data for additional years for raw data. 
```{r}
raw_y2 <- raw_y1 %>% 
  mutate(year = year + 1, 
         total_length = total_length + 50, 
         effort = effort / 2)

raw_example <- bind_rows(raw_y1, raw_y2)
```

TODO: print/save simplest complete example data


## Calculate metrics

TODO: refactor these into functions, test with example dataset

### 1. CPUE

For time-based methods, convert effort from seconds to hours. Calculate CPUE by dividing number of fish records for each species by effort. 

```{r}
cpue <- raw_example %>% 
  select(state, common_name, method, waterbody_type, year, effort) %>% 
  mutate(effort = ifelse(method %in% c("boat_electrofishing", "tow_barge_electrofishing", "raft_electrofishing", "trawl"), 
                           effort / 3600, 
                           effort)) %>%
  add_count(state, common_name, method, waterbody_type, year) %>% 
  mutate(cpue = n / effort) %>% 
  group_by(state, common_name, method, waterbody_type) %>% 
  summarize_at(vars(cpue), list(mean = mean, se = se, 
                                `5%` = ~quantile(x = ., probs = 0.05),
                                `25%` = ~quantile(x = ., probs = 0.25),
                                `50%` = ~quantile(x = ., probs = 0.50),
                                `75%` = ~quantile(x = ., probs = 0.75),
                                `95%` = ~quantile(x = ., probs = 0.95)), 
               na.rm = TRUE)
```

Plot example processed data. 

```{r}
ggplot(cpue, aes(y = state)) +
        geom_boxplot(aes(xmin = `5%`,
                         xlower = `25%`,
                         xmiddle = `50%`,
                         xupper = `75%`,
                         xmax = `95%`),
                     stat = "identity") +
  facet_wrap(vars(common_name))
```


### 2. Length frequency

Calculate Gabelhouse category for each fish record using length and species identity. For each species and each year, determine proportion of records in each category. Then calculate mean and standard error of length frequency for each species by category across years. 

```{r}
lf <- raw_example %>% 
  select(state, common_name, method, waterbody_type, year, total_length) %>%
  mutate(gcat = psdAdd(total_length, common_name, what = "incremental")) %>% 
  group_by(state, common_name, method, waterbody_type, year) %>% 
  count(gcat) %>% 
  mutate(lenfreq = n / sum(n)) %>% 
  group_by(state, common_name, method, waterbody_type, gcat) %>% 
  summarize_at(vars(lenfreq), list(mean = mean, se = se), na.rm = TRUE)
```

Plot example processed data. 

```{r}
ggplot(lf, aes(x = gcat, y = mean)) +
  geom_bar(stat = "identity") +
  facet_wrap(vars(common_name)) +
        geom_errorbar(aes(ymin = mean - se,
                          ymax = mean + se),
                      width = 0)
```

### 3. Relative weight

Calculate Gabelhouse category for each fish record using length and species identity, and relative weight for each fish record using width, length, and species identity. Then calculate mean and standard error for relative weight for each species by category across years. 

```{r}
rw <- raw_example %>% 
  select(state, common_name, method, waterbody_type, year, weight, total_length) %>%
  mutate(gcat = psdAdd(total_length, common_name, what = "incremental"), 
         relweight= wrAdd(wt = weight, len = total_length, spec = common_name)) %>% 
  group_by(state, common_name, method, waterbody_type, gcat) %>% 
  summarize_at(vars(relweight), list(mean = mean, se = se, 
                                `5%` = ~quantile(x = ., probs = 0.05),
                                `25%` = ~quantile(x = ., probs = 0.25),
                                `50%` = ~quantile(x = ., probs = 0.50),
                                `75%` = ~quantile(x = ., probs = 0.75),
                                `95%` = ~quantile(x = ., probs = 0.95)), na.rm = TRUE)
```

Plot example processed data. 

```{r}
ggplot(rw, aes(x = gcat)) +
  geom_point(aes(y = mean)) +
  geom_line(aes(y = mean)) +
  facet_wrap(vars(common_name))
```

## Generate metrics dataset

Run 3 functions on user input data, then combine into final dataset. 
